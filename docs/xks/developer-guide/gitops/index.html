<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<title data-react-helmet="true">GitOps a la XKS | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/developer-guide/gitops"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="GitOps a la XKS | Xenit"><meta data-react-helmet="true" name="description" content="What is GitOps?"><meta data-react-helmet="true" property="og:description" content="What is GitOps?"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/developer-guide/gitops"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/gitops" hreflang="en"><link data-react-helmet="true" rel="alternate" href="http://xenitab.github.io/docs/xks/developer-guide/gitops" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c04f9c15.css">
<link rel="preload" href="/assets/js/runtime~main.4204da66.js" as="script">
<link rel="preload" href="/assets/js/main.27ea2934.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_TMUO themedImage--dark_uzRr"></div></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">üåú</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">üåû</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Xenit Kubernetes Service</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/index">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Developer Guide</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/xks/developer-guide/gitops">GitOps a la XKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/best-practices">Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/secrets-management">Secrets Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cloud-iam">Cloud IAM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/security">Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cd">Continuous Delivery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci">Continuous Integration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/observability">Observability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/flux">Flux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/networking">Networking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/reports">Reports</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/starboard">Starboard</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/wsl2">Working with XKF from Windows</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Operator Guide</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>GitOps a la XKS</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="what-is-gitops">What is GitOps?<a aria-hidden="true" class="hash-link" href="#what-is-gitops" title="Direct link to heading">‚Äã</a></h2><blockquote><p>GitOps works by using Git as a single source of truth for declarative infrastructure and applications. With GitOps, the use of software agents can alert on any divergence between Git and what is running in <!-- -->[an environment]<!-- -->. If there is a difference, Kubernetes reconcilers automatically update or rollback the cluster depending on what is appropriate. <!-- -->‚Äê<!-- --> <em><a href="https://www.weave.works/technologies/gitops/" target="_blank" rel="noopener noreferrer">Weave Works - Guide To GitOps</a></em></p></blockquote><p>XKS supports GitHub and Azure DevOps with almost identical workflows. XKF refers to these as Git providers. For simplicity, we refer to their CI/CD automation as &quot;pipelines&quot;. If you are using GitHub, whenever this text refers to &quot;pipeline&quot;, think &quot;GitHub Actions workflow&quot;. As you saw in the previous section, XKS comes with a set of pipelines that automatically detects app releases and promotes them through a series of environments. The allows both rapid iteration and strong validation of apps.</p><p>XKS is built around <a href="https://trunkbaseddevelopment.com/" target="_blank" rel="noopener noreferrer">trunk-based development</a>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="user-story-emilia-updates-an-app">User story: Emilia updates an app<a aria-hidden="true" class="hash-link" href="#user-story-emilia-updates-an-app" title="Direct link to heading">‚Äã</a></h2><p>In the previous section, we looked at deploying our first app to Kubernetes using a fully automatic flow. But what actually happened in that flow? This section tells the story about a developer called Emilia. She has updated an app packaged as a container image. A pipeline in the app&#x27;s repository has just tagged the container image as <code>a8b91c33</code> and uploaded it to a container registry.</p><p>The GitOps repository for Emilia&#x27;s app has a <code>gitops-promotion.yaml</code> that looks like this (for much more details, see the <a href="https://github.com/XenitAB/gitops-promotion" target="_blank" rel="noopener noreferrer">gitops-promotion</a> readme):</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token key atrule">prflow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> per</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">environments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> qa</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The <code>dev</code> and <code>qa</code> environments have <code>auto: true</code> which means that new releases will be automatically applied, while the <code>prod</code> environment is configured with <code>auto: false</code>. This means that pull requests must be merged by a human, presumably one that has verified that the update worked as expected in previous environments. The GitOps repository is configured to require checks on pull requests to pass in order to allow merge.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="applying-to-dev">Applying to dev<a aria-hidden="true" class="hash-link" href="#applying-to-dev" title="Direct link to heading">‚Äã</a></h3><p>The flow is fully automatic and is triggered by the container image upload.</p><img alt="Apply to dev" src="/img/assets/xks/developer-guide/developer-flow-apply-dev.jpg"><ol><li>The <img src="/img/gitops/acr-icon.png" style="width:1em"> / <img src="/img/gitops/ecr-icon.png" style="width:1em"> container image upload triggers a pipeline in the GitOps repository that runs the <img src="/img/gitops/devops-icon.png" style="width:1em"> / <img src="/img/gitops/github-icon.png" style="width:1em"> <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-new" target="_blank" rel="noopener noreferrer">gitops-promotion new</a> command. It pushes a new branch and updates the <code>dev</code> environment manifest for the app with the new tag. It then opens an &quot;auto-merging&quot; pull request to integrate the new tag into the main branch.</li><li>The <img src="/img/gitops/pr-icon.png" style="width:1em"> pull request triggers another pipeline that runs <img src="/img/gitops/devops-icon.png" style="width:1em"> / <img src="/img/gitops/github-icon.png" style="width:1em"> <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-new" target="_blank" rel="noopener noreferrer">gitops-promotion status</a> command. Since <code>dev</code> is the first environment in the list, it does nothing and reports success.</li><li>The pull request check turns green and the pull request is automatically merged by the Git provider.</li><li>The <img src="/img/gitops/fluxcdio-icon.png" style="width:1em"> Flux Kustomization controller detects that there has been an update to the app&#x27;s tag in the Git repository and applies this update to the Kubernetes resource for the app (typically a <code>Deployment</code>).</li><li>The pods running the new container image came up healthy and so Flux sets a commit status on the <code>main</code> branch in the GitOps repository, reporting that the update was successfully applied. This will be significant in the next section.</li></ol><h3 class="anchor anchorWithStickyNavbar_y2LR" id="applying-to-qa">Applying to qa<a aria-hidden="true" class="hash-link" href="#applying-to-qa" title="Direct link to heading">‚Äã</a></h3><img alt="Apply to qa" src="/img/assets/xks/developer-guide/developer-flow-apply-qa.jpg"><ol><li>Merging a promotion to the main branch triggers a pipeline in the GitOps repository that runs the <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-promote" target="_blank" rel="noopener noreferrer">gitops-promotion promote</a> command. Like <code>new</code>, it creates a branch and updates the <code>qa</code> environment manifest for the app with the new tag. Because the configuration for this environment says <code>auto: true</code> it creates an auto-merging pull request.</li><li>As before, this new pull request triggers another pipeline that runs the <code>status</code> command. This time there is a previous environment and the status command reads the Flux commit status for that environment. Since Flux managed to apply the change in <code>dev</code> the <code>status</code> command reports success.</li><li>The pull request check turns green and the pull request is automatically merged by the Git provider.</li><li>The Flux Kustomization controller detects that there has been an update to the app&#x27;s tag in the Git repository and applies this update to the Kubernetes resource for the app (typically a <code>Deployment</code>).</li><li>In this case, someone had applied manual changes to the app&#x27;s database in the <code>dev</code> environment during development. These updates are not present in the <code>qa</code> environment, and when the pods running the new container image come up, they cannot read state from the database and so fail their health check. Flux consequently sets a commit status on the <code>main</code> branch of the GitHub repository, reporting that the update failed.</li></ol><p>Emilia&#x27;s team has configured Flux to notify them when updates fail and so Emilia&#x27;s chat client informs her that the update did not go through.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="application-to-prod-is-blocked">Application to prod is blocked<a aria-hidden="true" class="hash-link" href="#application-to-prod-is-blocked" title="Direct link to heading">‚Äã</a></h3><img alt="Apply to prod" src="/img/assets/xks/developer-guide/developer-flow-apply-prod-blocked.jpg"><p>The workflow for applying to <code>prod</code> is similar to that of <code>qa</code> above, but since Flux reported failure when applying the update to <code>qa</code>, the pipeline running the <code>status</code> command will fail and the Git provider will block merging of the pull request.</p><p>Seeing that the rollout failed, Emilia investigates and realizes that the release is missing a database migration script. She pushes an updated release tagged <code>cc2b7e0a</code> and so triggers the pipline running the <code>new</code> command. Because the configuration says <code>prflow: per-app</code>, the command &quot;resets&quot; the blocked pull request to apply to the updated release to the <code>dev</code> environment.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="second-attempt-applying-to-prod">Second attempt applying to prod<a aria-hidden="true" class="hash-link" href="#second-attempt-applying-to-prod" title="Direct link to heading">‚Äã</a></h3><img alt="Apply to prod" src="/img/assets/xks/developer-guide/developer-flow-apply-prod-success.jpg"><p>Emilia&#x27;s updated app with database migration is successfully applied, first to the <code>dev</code> environment and then to the <code>qa</code> environment. The <code>status</code> check for the pull request against <code>prod</code> turns green and the pull request can be merged. Since the configuration says <code>auto: false</code>, the pull request is not automatically merged. Emilia can now verify the update in the <code>qa</code> environment and then merge the pull request through the Git provider&#x27;s user interface.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/developer-guide/gitops.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/developer-guide/introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/developer-guide/best-practices"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Best Practices<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-gitops" class="table-of-contents__link toc-highlight">What is GitOps?</a></li><li><a href="#user-story-emilia-updates-an-app" class="table-of-contents__link toc-highlight">User story: Emilia updates an app</a><ul><li><a href="#applying-to-dev" class="table-of-contents__link toc-highlight">Applying to dev</a></li><li><a href="#applying-to-qa" class="table-of-contents__link toc-highlight">Applying to qa</a></li><li><a href="#application-to-prod-is-blocked" class="table-of-contents__link toc-highlight">Application to prod is blocked</a></li><li><a href="#second-attempt-applying-to-prod" class="table-of-contents__link toc-highlight">Second attempt applying to prod</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.4204da66.js"></script>
<script src="/assets/js/main.27ea2934.js"></script>
</body>
</html>