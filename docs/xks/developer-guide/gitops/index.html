<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<title data-react-helmet="true">GitOps a la XKS | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="GitOps a la XKS | Xenit"><meta data-react-helmet="true" name="description" content="What is GitOps?"><meta data-react-helmet="true" property="og:description" content="What is GitOps?"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/xks/developer-guide/gitops"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/xks/developer-guide/gitops"><link rel="stylesheet" href="/styles.b2afff22.css">
<link rel="preload" href="/styles.3762a54a.js" as="script">
<link rel="preload" href="/runtime~main.c8b46868.js" as="script">
<link rel="preload" href="/main.c8e20889.js" as="script">
<link rel="preload" href="/1.a46f6efc.js" as="script">
<link rel="preload" href="/31.e28a15fd.js" as="script">
<link rel="preload" href="/32.0fedd394.js" as="script">
<link rel="preload" href="/935f2afb.c98949a1.js" as="script">
<link rel="preload" href="/30.21fb5129.js" as="script">
<link rel="preload" href="/bf1bb071.5e31e1be.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Xenit Kubernetes Service</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/index">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/architecture-and-design">Architecture and design</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Developer Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/introduction">Introduction</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/xks/developer-guide/gitops">GitOps a la XKS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/best-practices">Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/secrets-management">Secrets Managenent</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cloud-iam">Cloud IAM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/security">Security</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/cd">Continuous Delivery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/ci">Continuous Integration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/flux">Flux</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/networking">Networking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/xks/developer-guide/wsl2">Working with XKF from Windows</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Operator Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/index">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/getting-started">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/agents">Agents</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/blast-radius">Blast Radius</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/blue-green">Blue Green Clusters</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/aws-azdo">AWS azure-devops</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/github">XKF on Github</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/kubernetes/aks">AKS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/xks/operator-guide/kubernetes/eks">EKS</a></li></ul></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">GitOps a la XKS</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="what-is-gitops"></a>What is GitOps?<a aria-hidden="true" class="hash-link" href="#what-is-gitops" title="Direct link to heading">#</a></h2><blockquote><p>GitOps works by using Git as a single source of truth for declarative infrastructure and applications. With GitOps, the use of software agents can alert on any divergence between Git with what&#x27;s running in [an environment], and if there&#x27;s a difference, Kubernetes reconcilers automatically update or rollback the cluster depending on the case. ‚Äê <em><a href="https://www.weave.works/technologies/gitops/" target="_blank" rel="noopener noreferrer">Weave Works - Guide To GitOps</a></em></p></blockquote><p>XKS supports GitHub and Azure DevOps with almost identical workflows. XKF refers to these as Git providers. For simplicity, we refer to their CI/CD automation as &quot;pipelines&quot;. If you are using GitHub, whenever this text refers to &quot;pipeline&quot;, think &quot;GitHub Actions workflow&quot;. As you saw in the previous section, XKS comes with a set of pipelines that automatically detects app releases and promotes them through a series of environments. The allows both rapid iteration and strong validation of apps.</p><p>XKS is built around <a href="https://trunkbaseddevelopment.com/" target="_blank" rel="noopener noreferrer">trunk-based development</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="user-story-emilia-updates-an-app"></a>User story: Emilia updates an app<a aria-hidden="true" class="hash-link" href="#user-story-emilia-updates-an-app" title="Direct link to heading">#</a></h2><p>In the previous section, we looked at deploying our first app to Kubernetes using a fully automatic flow. But what actually happened in that flow? This section tells the story about a developer called Emilia. She has updated an app packaged as a container image. A pipeline in the app&#x27;s repository has just tagged the container image as <code>a8b91c33</code> and uploaded it to a container registry.</p><p>The GitOps repository for Emilia&#x27;s app has a <code>gitops-promotion.yaml</code> that looks like this (for much more details, see the <a href="https://github.com/XenitAB/gitops-promotion" target="_blank" rel="noopener noreferrer">gitops-promotion</a> readme):</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">prflow</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> per</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">environments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> dev</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> qa</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">env</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> prod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">auto</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">false</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The <code>dev</code> and <code>qa</code> environments have <code>auto: true</code> which means that new releases will be automatically applied, while <code>prod</code> environment is configured with <code>auto: false</code>. This means that pull requests must be merged by a human, presumably one that has verified that the update worked as expected in previous environments. The GitOps repository is configured to require checks on pull requests to pass in order to allow merge.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="applying-to-dev"></a>Applying to dev<a aria-hidden="true" class="hash-link" href="#applying-to-dev" title="Direct link to heading">#</a></h3><p>The flow is fully automatic and is triggered by the container image upload.</p><img alt="Apply to dev" src="/img/assets/xks/developer-guide/developer-flow-apply-dev.jpg"><ol><li>The <img src="/static/img//gitops/acr-icon.png" style="width:1em"> / <img src="/static/img//gitops/ecr-icon.png" style="width:1em"> container image upload triggers a pipeline in the GitOps repository that runs the <img src="/static/img//gitops/devops-icon.png" style="width:1em"> / <img src="/static/img//gitops/github-icon.png" style="width:1em"> <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-new" target="_blank" rel="noopener noreferrer">gitops-promotion new</a> command. It pushes a new branch and updates the <code>dev</code> environment manifest for the app with the new tag. It then opens an &quot;auto-merging&quot; pull request to integrate the new tag into the main branch.</li><li>The <img src="/static/img//gitops/pr-icon.png" style="width:1em"> pull request triggers another pipeline that runs <img src="/static/img//gitops/devops-icon.png" style="width:1em"> / <img src="/static/img//gitops/github-icon.png" style="width:1em"> <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-new" target="_blank" rel="noopener noreferrer">gitops-promotion status</a> command. Since <code>dev</code> is the first environment in the list, it does nothing and reports success.</li><li>The pull request check turns green and the pull request is automatically merged by Git provider.</li><li>The <img src="/static/img//gitops/fluxcdio-icon.png" style="width:1em"> Flux Kustomization controller detects that there has been an update to the app&#x27;s tag in the Git repository and applies this update to the Kubernetes resource for the app (typically a <code>Deployment</code>).</li><li>The pods running the new container image came up healthy and so Flux sets a commit status on the <code>main</code> branch in the GitOps repository, reporting that the update was successfully applied. This will be significant in the next section.</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="applying-to-qa"></a>Applying to qa<a aria-hidden="true" class="hash-link" href="#applying-to-qa" title="Direct link to heading">#</a></h3><img alt="Apply to qa" src="/img/assets/xks/developer-guide/developer-flow-apply-qa.jpg"><ol><li>Merging a promotion to the main branch triggers a pipeline in the GitOps repository that runs the <a href="https://github.com/XenitAB/gitops-promotion#gitops-promotion-promote" target="_blank" rel="noopener noreferrer">gitops-promotion promote</a> command. Like <code>new</code>, it creates a branch and updates the <code>qa</code> envrionment manifest for the app with the new tag. Because the configuration for this environment says <code>auto: true</code> it creates an auto-merging pull request.</li><li>As before, this new pull request triggers antoher pipeline that runs the <code>status</code> command. This time there is a previous environment and the status command reads the Flux commit status for that environment. Since Flux managed to apply the change in <code>dev</code> the <code>status</code> command reports success.</li><li>The pull request check turns green and the pull request is automatically merged by Git provider.</li><li>The Flux Kustomization controller detects that there has been an update to the app&#x27;s tag in the Git repository and applies this update to the Kubernetes resource for the app (typically a <code>Deployment</code>).</li><li>In this case, someone had applied manual changes to the app&#x27;s database in the <code>dev</code> environment during development. These updates are not present in the <code>qa</code> environment, and when the pods running the new container image come up, they cannot read state from the database and so fail their health check. Flux consequently sets a commit status on the <code>main</code> branch of the GitHub repository, reporting that the update failed.</li></ol><p>Emilia&#x27;s team has configured Flux to notify them when updates fail and so Emilia&#x27;s chat client informs her that the update did not go through.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="application-to-prod-is-blocked"></a>Application to prod is blocked<a aria-hidden="true" class="hash-link" href="#application-to-prod-is-blocked" title="Direct link to heading">#</a></h3><img alt="Apply to prod" src="/img/assets/xks/developer-guide/developer-flow-apply-prod-blocked.jpg"><p>The workflow for applying to <code>prod</code> is similar to that of <code>qa</code> above, but since Flux reported failure when applying the update to <code>qa</code>, the pipeline running the <code>status</code> command will fail and the Git provider will block merging of the pull request.</p><p>Seeing that the rollout failed, Emilia investigates and realizes that the release is missing a database migration script. She pushes an updated release tagged <code>cc2b7e0a</code> and so triggers the pipline running the <code>new</code> command. Because the configuration says <code>prflow: per-app</code>, the command &quot;resets&quot; the blocked pull request to apply to the updated release to the <code>dev</code> environment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="second-attempt-applying-to-prod"></a>Second attempt applying to prod<a aria-hidden="true" class="hash-link" href="#second-attempt-applying-to-prod" title="Direct link to heading">#</a></h3><img alt="Apply to prod" src="/img/assets/xks/developer-guide/developer-flow-apply-prod-success.jpg"><p>Emilia&#x27;s updated app with database migration is successfully applied first to the <code>dev</code> environment and then to the <code>qa</code> environment. The <code>status</code> check for the pull request against <code>prod</code> turns green and the pull request can be merged. Since the configuration says <code>auto: false</code>, the pull request is not automatically merged. Emilia can now verify the update in the <code>qa</code> environment and then merge the pull request through the Git provider&#x27;s user interface.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/developer-guide/gitops.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/xks/developer-guide/introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Introduction</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/xks/developer-guide/best-practices"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Best Practices ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-gitops" class="table-of-contents__link">What is GitOps?</a></li><li><a href="#user-story-emilia-updates-an-app" class="table-of-contents__link">User story: Emilia updates an app</a><ul><li><a href="#applying-to-dev" class="table-of-contents__link">Applying to dev</a></li><li><a href="#applying-to-qa" class="table-of-contents__link">Applying to qa</a></li><li><a href="#application-to-prod-is-blocked" class="table-of-contents__link">Application to prod is blocked</a></li><li><a href="#second-attempt-applying-to-prod" class="table-of-contents__link">Second attempt applying to prod</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/styles.3762a54a.js"></script>
<script src="/runtime~main.c8b46868.js"></script>
<script src="/main.c8e20889.js"></script>
<script src="/1.a46f6efc.js"></script>
<script src="/31.e28a15fd.js"></script>
<script src="/32.0fedd394.js"></script>
<script src="/935f2afb.c98949a1.js"></script>
<script src="/30.21fb5129.js"></script>
<script src="/bf1bb071.5e31e1be.js"></script>
</body>
</html>