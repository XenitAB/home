<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<title data-react-helmet="true">Operator Guide | Xenit</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Operator Guide | Xenit"><meta data-react-helmet="true" name="description" content="Bootstrap"><meta data-react-helmet="true" property="og:description" content="Bootstrap"><meta data-react-helmet="true" property="og:url" content="http://xenitab.github.io/docs/services/xks/operator-guide"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://xenitab.github.io/docs/services/xks/operator-guide"><link rel="stylesheet" href="/styles.b2afff22.css">
<link rel="preload" href="/styles.b02ad73b.js" as="script">
<link rel="preload" href="/runtime~main.edd745c5.js" as="script">
<link rel="preload" href="/main.2fdf1e49.js" as="script">
<link rel="preload" href="/1.7c06d8d3.js" as="script">
<link rel="preload" href="/70.93e04174.js" as="script">
<link rel="preload" href="/71.d61ad9bc.js" as="script">
<link rel="preload" href="/935f2afb.aa0421ad.js" as="script">
<link rel="preload" href="/69.3570548a.js" as="script">
<link rel="preload" href="/8cc8c2e1.a1265d23.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/Xenit_logo_Svart.png" alt="Xenit logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img src="/img/Xenit_logo_Vit.png" alt="Xenit logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/XenitAB" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Documentation</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/documentation/kubernetes/oneoone">101</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/documentation/kubernetes/best-practices">Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/documentation/kubernetes/blast-radius">OPA Blast Radius</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Services</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">Xenit Kubernetes Service</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/services/xks/index">Overview</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/services/xks/operator-guide">Operator Guide</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/services/xks/azure-devops-agents">Azure DevOps agents</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/services/xks/developer-guide">Developer Guide</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Terraform Modules</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Aws</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/aws">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/aws/core">Core</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/aws/eks">eks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/aws/eks-global">eks-global</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/aws/irsa">IRSA</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Azure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/aks">Azure Kubernetes Service</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/aks-global">Azure Kubernetes Service - Global</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/azure-pipelines-agent-vmss">Azure Pipelines Agent</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/core">Core</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/github-runner">GitHub Actions Self-hosted Runner</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/governance">Governance (Deprecated)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/governance-global">Governance (Global)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/governance-regional">Governance (Regional)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/azure/hub">Hub</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Kubernetes</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/aad-pod-identity">Azure AD POD Identity (AAD-POD-Identity)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/aks-core">AKS Core</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/azad-kube-proxy">Azure AD Kubernetes API Proxy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/cert-manager">Certificate manager (cert-manager)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/cluster-autoscaler">Cluster Autoscaler (cluster-autoscaler)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/csi-secrets-store-provider-aws">AWS Key Vault Provider for Secrets Store CSI Driver</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/csi-secrets-store-provider-azure">Azure Key Vault Provider for Secrets Store CSI Driver</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/datadog">Datadog</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/eks-core">EKS Core</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/external-dns">External DNS (external-dns)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/external-secrets">External Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/falco">Falco</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/fluxcd-v1">Flux (v1)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/fluxcd-v2-azdo">Flux V2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/fluxcd-v2-github">Flux V2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/goldpinger">Goldpinger</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/ingress-healthz">Ingress Healthz (ingress-healthz)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/ingress-nginx">Ingress NGINX (ingress-nginx)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/kyverno">kyverno</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/linkerd">Linkerd</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/loki">Grafana Loki</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/opa-gatekeeper">OPA Gatekeeper</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/prometheus">Prometheus</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/reloader">Reloader</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/velero">Velero</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/terraform-modules/kubernetes/xenit">Xenit Platform Configuration</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Azure DevOps Templates</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/gitops">GitOps</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/gitops-v2">Gitops V2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/packer">Packer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/packer-docker">Packer (Docker)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/terraform">Terraform</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/azure-devops-templates/terraform-docker">Terraform (Docker)</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Operator Guide</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="bootstrap"></a>Bootstrap<a aria-hidden="true" class="hash-link" href="#bootstrap" title="Direct link to heading">#</a></h2><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="add-new-tenant"></a>Add New Tenant<a aria-hidden="true" class="hash-link" href="#add-new-tenant" title="Direct link to heading">#</a></h2><p>When creating a new tenant there a number of for now manual processes to make.</p><p>In this scenario we are assuming that you are using azure devops and that you have already created a project and organization.</p><p>In your project lets call it project1 in the future manually import a repository.
<a href="https://github.com/XenitAB/azure-devops-templates" target="_blank" rel="noopener noreferrer">https://github.com/XenitAB/azure-devops-templates</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="import-azure-devops-templates-pipeline"></a>Import azure-devops-templates pipeline<a aria-hidden="true" class="hash-link" href="#import-azure-devops-templates-pipeline" title="Direct link to heading">#</a></h3><p>To make sure that the azure-devops-templates repo is up to date we have a automatic CI that fetches updates from upstream to your local azure devops clone.</p><p>Go to pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; azure-devops-templates -&gt; Existing Azure Pipelines YAML file</p><p>Import the pipeline from the following path: /.ci/pipeline.yaml</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="setup-xks"></a>Setup XKS<a aria-hidden="true" class="hash-link" href="#setup-xks" title="Direct link to heading">#</a></h3><p>In this case we will only setup a single XKS cluster in one environment, in our case dev.
It&#x27;s easy to add more environments when you have created your first one.</p><p>At Xenit we are using terraform modules that we share <a href="https://github.com/XenitAB/terraform-modules" target="_blank" rel="noopener noreferrer">upstream</a></p><p>To setup XKS we will utilize 4 modules:</p><ul><li>governance-global</li><li>governance-regional</li><li>core</li><li>aks</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="create-terraform-repo"></a>Create terraform repo<a aria-hidden="true" class="hash-link" href="#create-terraform-repo" title="Direct link to heading">#</a></h3><p>Of course we need a place to store our terraform code so create on in your azure devops organization.
TODO create a example repo that uses our terraform modules.</p><p>You can today see a example of the <a href="https://github.com/XenitAB/azure-devops-templates/blob/master/terraform-docker/README.md#makefile" target="_blank" rel="noopener noreferrer">Makefile</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="update-repo"></a>Update repo<a aria-hidden="true" class="hash-link" href="#update-repo" title="Direct link to heading">#</a></h3><p>We need to update a number of settings in a number of places in your terraform repo.</p><p>Generate a SUFFIX that should be tfstate + a few random numbers, for example &quot;tfstate1234&quot;</p><p>Update the Makefile SUFFIX variable with the suffix and the random number.</p><p>Also update global.tfvars with the same random number.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="create-terraform-storage"></a>Create terraform storage<a aria-hidden="true" class="hash-link" href="#create-terraform-storage" title="Direct link to heading">#</a></h3><p>In order to store a terraform state we need to prepare that.</p><p>We have written a small golang tool that will help out with <a href="https://github.com/XenitAB/github-actions/tree/main/docker/go-tf-prepare" target="_blank" rel="noopener noreferrer">that</a></p><p>Instead of running these a number of these scripts manually we will use the make file.</p><p>We use one terrafrom state per DIR and environment.
Lets create the first terraform state, in this case governance.</p><p><code>make prepare ENV=dev DIR=governance</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cicd"></a>CI/CD<a aria-hidden="true" class="hash-link" href="#cicd" title="Direct link to heading">#</a></h3><p>We will have one CI/CD pipeline per DIR.
You can find ready to use pipelines under .ci/ in the terraform repo.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="update-pipelines"></a>Update pipelines<a aria-hidden="true" class="hash-link" href="#update-pipelines" title="Direct link to heading">#</a></h4><p>Update the variable azureSubscriptionTemplate. You can find the value under Project settings -&gt; Service Connections</p><img alt="Service Connections" src="/img/operator/project_settings.png"><p>In my case sp-sub-project1-xks</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> $(Build.BuildId)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">variables</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> azureSubscriptionTemplate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;sp-sub-project1-xks-{0}-owner&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> terraformFolder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;governance&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> sourceBranch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;refs/heads/main&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Also update the project path in name. Also notice the ref, the ref points to witch version of the module that you are using.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">repositories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">repository</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> templates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">type</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> project1/azure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">devops</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">templates</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">ref</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> refs/tags/2021.03.1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="add-cicd-piplines"></a>Add CI/CD piplines<a aria-hidden="true" class="hash-link" href="#add-cicd-piplines" title="Direct link to heading">#</a></h4><p>Once again add a pipeline.</p><p>Assuming that you named your repository to terraform</p><p>Pipelines -&gt; New pipeline -&gt; Azure Repos Git -&gt; terraform -&gt; Existing Azure Pipelines YAML file</p><p>Import the pipeline from the following path: .ci/pipeline-governance.yaml</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="governence-stage-done"></a>Governence stage done<a aria-hidden="true" class="hash-link" href="#governence-stage-done" title="Direct link to heading">#</a></h4><p>Hopefully after adding the pipeline the pipeline should automatically trigger and the plan and apply stage should go thourgh without a problem.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="confgiure-core"></a>confgiure core<a aria-hidden="true" class="hash-link" href="#confgiure-core" title="Direct link to heading">#</a></h3><p>Get a CIDR network for your AKS env per env.
Define in core/variables/env.tfvars</p><p>Run the prepare script to create a location for your state file.
<code>make prepare ENV=dev DIR=core</code></p><p>Othen then that you should edit .ci just like you did for governance.
Add the pipeline and run it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configure-aks"></a>configure AKS<a aria-hidden="true" class="hash-link" href="#configure-aks" title="Direct link to heading">#</a></h3><p>Time to install AKS.</p><p>Start to update main.tf to point on your organization/project.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-main.tf codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fluxcd_v2_enabled = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fluxcd_v2_config = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type = &quot;azure_devops&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    github = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      owner = &quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    azure_devops = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      org  = &quot;organization1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      pat  = data.azurerm_key_vault_secret.azure_devops_pat.value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      proj = &quot;project1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Notice the org and proj</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="create-pat-secret"></a>Create PAT secret<a aria-hidden="true" class="hash-link" href="#create-pat-secret" title="Direct link to heading">#</a></h3><p>To make it possible for flux to clone repos from azure devops we need to create a Personal Access Token(PAT).</p><p>User Settings -&gt; Personal access tokens -&gt; New Token</p><img alt="Settings user" src="/img/operator/settings_user.png"><p>Create a PAT</p><img alt="Create PAT" src="/img/operator/create_pat.png"><p>Copy the generated key, we will need it for the next step.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="add-pat-to-azure-key-vaults"></a>Add PAT to Azure Key Vaults<a aria-hidden="true" class="hash-link" href="#add-pat-to-azure-key-vaults" title="Direct link to heading">#</a></h3><p>To make it possible for terraform to reach the PAT in a easy and secure way we have chosen to store the PAT in Azure Key Vaults which you need to add manually.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="az-cli"></a>az cli<a aria-hidden="true" class="hash-link" href="#az-cli" title="Direct link to heading">#</a></h4><p>You can add the secret using the az cli.</p><p>Call the secret azure-devops-pat and the value should be the token you created in azure devops.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-bash codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># List all key vaults</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Create the secret</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">az keyvault secret </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">set</span><span class="token plain"> --vault-name kv-dev-we-core-1234 --name azure-devops-pat --value </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;SuperSecretToken123&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="azure-portal"></a>Azure portal<a aria-hidden="true" class="hash-link" href="#azure-portal" title="Direct link to heading">#</a></h4><p>Or if you prefer use the UI.</p><p>In azure portal search for &quot;Key vaults&quot; and pick the core one that matches the unique_suffix that you have specified in global.tfvars, in our case 1234.</p><p>Key vaults -&gt; core-1234 -&gt; Secrets -&gt; Generate/Import</p><img alt="Azure Key Vaults" src="/img/operator/azure_key_vault.jpg"><p>Call the secret &quot;azure-devops-pat&quot; and add the PAT key that you created in the previous step.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="gitops-using-flux"></a>GitOps using flux<a aria-hidden="true" class="hash-link" href="#gitops-using-flux" title="Direct link to heading">#</a></h3><p>If you want flux to manage your GitOps repo from the get go you can enable this in aks/variables/common.tfvars
In my case I will have flux manage a namespace called monitor and sync a repo under monitor-gitops.</p><p>Make sure that you create this repository before running terraform.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-common.tfvars codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespaces = [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name                    = &quot;monitor&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    delegate_resource_group = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    labels = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;terraform&quot; = &quot;true&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    flux = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      enabled = true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      azure_devops = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        org  = &quot;organization1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        proj = &quot;project1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;monitor-gitops&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      github = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        repo = &quot;&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configure-aks-cluster"></a>Configure AKS cluster<a aria-hidden="true" class="hash-link" href="#configure-aks-cluster" title="Direct link to heading">#</a></h3><ul><li>How big should your cluster be?</li><li>Which version of kubernetes should you run?</li><li>What DNS zone should you use?</li><li>What SKU tier should your cluster have?</li><li>What size should your k8s nodes have?</li></ul><p>All of this is configured under aks/variables/prod.tfvars</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-prod.tfvars codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">environment = &quot;dev&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">dns_zone    = &quot;dev.aks.xenit.io&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">aks_config = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kubernetes_version = &quot;1.19.7&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sku_tier           = &quot;Free&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  default_node_pool = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    orchestrator_version = &quot;1.19.7&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    vm_size              = &quot;Standard_B2s&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    min_count            = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    max_count            = 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    node_labels          = {}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  additional_node_pools = []</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><blockquote><p>Notice the vm_size = Standard_B2s</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="admin-and-developer-access"></a>Admin and developer access<a aria-hidden="true" class="hash-link" href="#admin-and-developer-access" title="Direct link to heading">#</a></h2><p>Hopefully you should now have one XKS cluster up and running, but currently no developer can actually reach the cluster.</p><p>In XKF we see clusters as cattle and at any time we can decide to recreate a XKS cluster.
To be able to do this without our developers even knowing we use blue green clusters, TODO write a document on how blue green clusters works and link.
We use GitOps together with DNS to be able to migrate applications without any impact to end-users assuming that our developers have written 12 step applications.
To store state we utilize the cloud services available in the different clouds that XKF supports.</p><p>To make sure that our developers don&#x27;t notice when we change our the cluster we have written a Kubernetes API Proxy called <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer">azad-kube-proxy</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="azure-ad-kubernetes-proxy"></a>Azure AD Kubernetes Proxy<a aria-hidden="true" class="hash-link" href="#azure-ad-kubernetes-proxy" title="Direct link to heading">#</a></h3><p>AZAD as we also call it, is a deployment that runs inside XKS and sits in front of the kubernetes API.</p><p>We also supply a krew/kubectl plugin to make it easy for our developers to use AZAD.
For instructions on how to setup and configure <a href="https://github.com/XenitAB/azad-kube-proxy" target="_blank" rel="noopener noreferrer">see</a>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="azad-usage"></a>AZAD Usage<a aria-hidden="true" class="hash-link" href="#azad-usage" title="Direct link to heading">#</a></h4><p>Install krew: <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows" target="_blank" rel="noopener noreferrer">https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows</a>
Install azad-proxy plugin: kubectl krew install azad-proxy
Login with azure cli (a valid session with azure cli is always required): az login
Discover the clusters: kubectl azad-proxy discover</p><p>There are two ways to connect to the cluster using azad.</p><p>Ether use the menu feature:
<code>kubectl azad-proxy menu</code></p><p>Or connect by using the generate command:
<code>kubectl azad-proxy generate --cluster-name dev-cluster --proxy-url https://dev.example.com --resource https://dev.example.com</code></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="aad-groups"></a>AAD groups<a aria-hidden="true" class="hash-link" href="#aad-groups" title="Direct link to heading">#</a></h3><p>To make it possible for our developers and admins to actually login to the cluster we need to add them to a AAD group.</p><p>If you are a AAD guest user you need to add the AAD Role: <strong>Directory Reader</strong> to your user account.
AZAD proxy parses the AAD and that is why the user needs Directory Reader.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="developer-groups"></a>Developer groups<a aria-hidden="true" class="hash-link" href="#developer-groups" title="Direct link to heading">#</a></h4><p>Depending on what configuration you did in global.tfvars this will differ but the group name should be something like bellow.</p><p>This group will give your developers contributor access in the namespaces where they have access.</p><p><code>&lt;azure_ad_group_prefix&gt;-rg-xks-&lt;cluster-env&gt;-aks-contributor</code></p><p>Example: <code>az-rg-xks-dev-aks-contributor</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="admin-groups"></a>Admin groups<a aria-hidden="true" class="hash-link" href="#admin-groups" title="Direct link to heading">#</a></h4><p>To make it easy for you as a admin you should also use AZAD.</p><p>To give your self cluster-admin:</p><p><code>&lt;azure_ad_group_prefix&gt;-xks-&lt;cluster-env&gt;-clusteradmin</code></p><p>Example: aks-xks-dev-clusteradmin</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="authorized-ip"></a>Authorized IP<a aria-hidden="true" class="hash-link" href="#authorized-ip" title="Direct link to heading">#</a></h3><p>To minimize the exposure of the XKS clusters we define a list of authorized ip:s that is approved to connect the kubernetes cluster API.</p><p>We need to approve multiple infrastructure networks and user networks.</p><ul><li>If you are using the HUB module and you are running VMSS Azure Devops Agent you need to approve those IP:s as authorized.</li><li>The AKS public ip</li><li>Your developers public ip</li></ul><p>A recommendations is to add a comment with what IP you have added.</p><p>aks_authorized_ips = [
&quot;8.8.8.8/32&quot;,  # google dns
&quot;1.2.3.4/32&quot;,  # developer x ip
&quot;2.3.4.5/30&quot;,  # AKS0 dev
]</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/xenitab/xenitab.github.io/edit/main/docs/services/xks/operator-guide.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/services/xks/index"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Overview</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/services/xks/azure-devops-agents"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Azure DevOps agents Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bootstrap" class="table-of-contents__link">Bootstrap</a></li><li><a href="#add-new-tenant" class="table-of-contents__link">Add New Tenant</a><ul><li><a href="#import-azure-devops-templates-pipeline" class="table-of-contents__link">Import azure-devops-templates pipeline</a></li><li><a href="#setup-xks" class="table-of-contents__link">Setup XKS</a></li><li><a href="#create-terraform-repo" class="table-of-contents__link">Create terraform repo</a></li><li><a href="#update-repo" class="table-of-contents__link">Update repo</a></li><li><a href="#create-terraform-storage" class="table-of-contents__link">Create terraform storage</a></li><li><a href="#cicd" class="table-of-contents__link">CI/CD</a></li><li><a href="#confgiure-core" class="table-of-contents__link">confgiure core</a></li><li><a href="#configure-aks" class="table-of-contents__link">configure AKS</a></li><li><a href="#create-pat-secret" class="table-of-contents__link">Create PAT secret</a></li><li><a href="#add-pat-to-azure-key-vaults" class="table-of-contents__link">Add PAT to Azure Key Vaults</a></li><li><a href="#gitops-using-flux" class="table-of-contents__link">GitOps using flux</a></li><li><a href="#configure-aks-cluster" class="table-of-contents__link">Configure AKS cluster</a></li></ul></li><li><a href="#admin-and-developer-access" class="table-of-contents__link">Admin and developer access</a><ul><li><a href="#azure-ad-kubernetes-proxy" class="table-of-contents__link">Azure AD Kubernetes Proxy</a></li><li><a href="#aad-groups" class="table-of-contents__link">AAD groups</a></li><li><a href="#authorized-ip" class="table-of-contents__link">Authorized IP</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/styles.b02ad73b.js"></script>
<script src="/runtime~main.edd745c5.js"></script>
<script src="/main.2fdf1e49.js"></script>
<script src="/1.7c06d8d3.js"></script>
<script src="/70.93e04174.js"></script>
<script src="/71.d61ad9bc.js"></script>
<script src="/935f2afb.aa0421ad.js"></script>
<script src="/69.3570548a.js"></script>
<script src="/8cc8c2e1.a1265d23.js"></script>
</body>
</html>