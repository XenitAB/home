"use strict";(self.webpackChunkhome=self.webpackChunkhome||[]).push([[451],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=a,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||o;return n?r.createElement(m,i(i({ref:t},u),{},{components:n})):r.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4737:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return u},default:function(){return d}});var r=n(7462),a=n(3366),o=(n(7294),n(3905)),i=["components"],s={id:"networking",title:"Networking"},l=void 0,c={unversionedId:"xks/operator-guide/networking",id:"xks/operator-guide/networking",isDocsHomePage:!1,title:"Networking",description:"There are a lot of moving parts when looking at networking and Kubernetes. There are both Kubernetes specific components such as kube-proxy and CoreDNS but also cloud specific components such as the",source:"@site/docs/xks/operator-guide/networking.md",sourceDirName:"xks/operator-guide",slug:"/xks/operator-guide/networking",permalink:"/docs/xks/operator-guide/networking",editUrl:"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/networking.md",tags:[],version:"current",frontMatter:{id:"networking",title:"Networking"},sidebar:"docs",previous:{title:"Agents",permalink:"/docs/xks/operator-guide/agents"},next:{title:"Blast Radius",permalink:"/docs/xks/operator-guide/blast-radius"}},u=[{value:"Kubernetes",id:"kubernetes",children:[],level:2},{value:"Azure",id:"azure",children:[{value:"SNAT Exhaustion",id:"snat-exhaustion",children:[{value:"Links",id:"links",children:[],level:4}],level:3}],level:2},{value:"AWS",id:"aws",children:[],level:2}],p={toc:u};function d(e){var t=e.components,n=(0,a.Z)(e,i);return(0,o.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"There are a lot of moving parts when looking at networking and Kubernetes. There are both Kubernetes specific components such as kube-proxy and CoreDNS but also cloud specific components such as the\nunderlying VNET/VPC, load balancer, and NAT gateways. The page aims to describe the architecture and some of the limitations and problems which can be experienced when working with XKS to help with\ndebugging networking issues."),(0,o.kt)("h2",{id:"kubernetes"},"Kubernetes"),(0,o.kt)("p",null,"TBD"),(0,o.kt)("h2",{id:"azure"},"Azure"),(0,o.kt)("p",null,"XKS in Azure uses a single VNET with a single subnet per AKS cluster. The VNET and subnets are created by the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/terraform-modules/tree/main/modules/azure/core"},"core module"),".\nAdditionally each AKS cluster also creates a load balancer. The load balancer is used for both ingress and egress traffic."),(0,o.kt)("p",null,"When a Kubernetes service of type ",(0,o.kt)("inlineCode",{parentName:"p"},"LoadBalancer")," is created a new IP is attached to the load balancer. An Azure load balancer can have multiple IPs attached to it so unlike AWS it does not have to\ncreate a new load balancer."),(0,o.kt)("p",null,"During the creation of the AKS cluster a public IP prefix is attached to the load balancer for egress traffic. This ensures that all traffic egress with the same source IP, enabling the use of IP\nwhite listing in external sources. This does however mean that all outbound traffic will also go through the same load balancer as the incoming traffic. There is currently work underway to enable the\nuse of managed NAT gateways for egress traffic in AKS, but it is currently ",(0,o.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/azure/aks/nat-gateway"},"in preview")," right now."),(0,o.kt)("h3",{id:"snat-exhaustion"},"SNAT Exhaustion"),(0,o.kt)("p",null,"Applications making large numbers of outgoing TCP or UDP connections to the same IP and port can cause an issue known as ",(0,o.kt)("em",{parentName:"p"},"SNAT port exhaustion"),". This is mostly due to the network architecture in Azure\nand AKS. All of the outgoing traffic from AKS goes through the load balancer, and for each outgoing request the load balancer needs to allocate an SNAT port to receive the response. Each Azure load\nbalancer will allocate 64000 SNAT ports. This may seem like a lot, but there is a caveat as AKS will limit the amount of SNAT ports per node. The amount of SNAT ports available per node depends on\nthe amount of nodes per cluster."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:"center"},"Node Count"),(0,o.kt)("th",{parentName:"tr",align:"center"},"SNAT Ports per Node"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"1-50"),(0,o.kt)("td",{parentName:"tr",align:"center"},"1024")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"51-100"),(0,o.kt)("td",{parentName:"tr",align:"center"},"512")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"101-200"),(0,o.kt)("td",{parentName:"tr",align:"center"},"256")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"201-400"),(0,o.kt)("td",{parentName:"tr",align:"center"},"128")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"401-800"),(0,o.kt)("td",{parentName:"tr",align:"center"},"64")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"center"},"801-1000"),(0,o.kt)("td",{parentName:"tr",align:"center"},"32")))),(0,o.kt)("p",null,"A symptom of exhausting the SNAT ports is that outgoing requests will just fail. This is of course not a good situation, and may be hard to debug as a failing request could be caused by many different\nfactors."),(0,o.kt)("h4",{id:"links"},"Links"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard#troubleshooting-snat"},"https://docs.microsoft.com/en-us/azure/aks/load-balancer-standard#troubleshooting-snat")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://docs.microsoft.com/en-us/azure/load-balancer/troubleshoot-outbound-connection"},"https://docs.microsoft.com/en-us/azure/load-balancer/troubleshoot-outbound-connection")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://www.danielstechblog.io/detecting-snat-port-exhaustion-on-azure-kubernetes-service/"},"https://www.danielstechblog.io/detecting-snat-port-exhaustion-on-azure-kubernetes-service/")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://medium.com/asos-techblog/an-aks-performance-journey-part-1-sizing-everything-up-ee6d2346ea99"},"https://medium.com/asos-techblog/an-aks-performance-journey-part-1-sizing-everything-up-ee6d2346ea99")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://medium.com/asos-techblog/an-aks-performance-journey-part-2-networking-it-out-e253f5bb4f69"},"https://medium.com/asos-techblog/an-aks-performance-journey-part-2-networking-it-out-e253f5bb4f69"))),(0,o.kt)("h2",{id:"aws"},"AWS"),(0,o.kt)("p",null,"TBD"))}d.isMDXComponent=!0}}]);