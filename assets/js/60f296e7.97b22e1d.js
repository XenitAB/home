"use strict";(self.webpackChunkhome=self.webpackChunkhome||[]).push([[6721],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},9246:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return u},metadata:function(){return p},toc:function(){return d},default:function(){return m}});var a=n(3117),r=n(102),o=(n(7294),n(3905)),i=n(4996),l=["components"],s={id:"getting-started",title:"Getting Started"},u=void 0,p={unversionedId:"xks/operator-guide/getting-started",id:"xks/operator-guide/getting-started",title:"Getting Started",description:"Bootstrap",source:"@site/docs/xks/operator-guide/getting-started.md",sourceDirName:"xks/operator-guide",slug:"/xks/operator-guide/getting-started",permalink:"/docs/xks/operator-guide/getting-started",editUrl:"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/getting-started.md",tags:[],version:"current",frontMatter:{id:"getting-started",title:"Getting Started"},sidebar:"docs",previous:{title:"Overview",permalink:"/docs/xks/operator-guide/"},next:{title:"Agents",permalink:"/docs/xks/operator-guide/agents"}},d=[{value:"Bootstrap",id:"bootstrap",children:[],level:2},{value:"Add New Tenant",id:"add-new-tenant",children:[{value:"Import azure-devops-templates pipeline",id:"import-azure-devops-templates-pipeline",children:[],level:3},{value:"Setup XKS",id:"setup-xks",children:[],level:3},{value:"Create Terraform repo",id:"create-terraform-repo",children:[],level:3},{value:"Update repo",id:"update-repo",children:[],level:3},{value:"Create Terraform storage",id:"create-terraform-storage",children:[],level:3},{value:"Configure governance",id:"configure-governance",children:[],level:3},{value:"Configure core",id:"configure-core",children:[],level:3},{value:"Configure AKS cluster",id:"configure-aks-cluster",children:[],level:3},{value:"GitOps using Flux",id:"gitops-using-flux",children:[],level:3}],level:2},{value:"Terraform CI/CD",id:"terraform-cicd",children:[{value:"Configure service principal",id:"configure-service-principal",children:[{value:"Service principal access",id:"service-principal-access",children:[],level:4},{value:"Create Service principal key",id:"create-service-principal-key",children:[],level:4}],level:3},{value:"Setup Service Connection",id:"setup-service-connection",children:[],level:3},{value:"Update pipelines",id:"update-pipelines",children:[],level:3},{value:"Add CI/CD pipelines",id:"add-cicd-pipelines",children:[],level:3},{value:"Create PAT secret",id:"create-pat-secret",children:[],level:3},{value:"Add PAT to Azure Key Vaults",id:"add-pat-to-azure-key-vaults",children:[{value:"Azure CLI",id:"azure-cli",children:[],level:4},{value:"Azure portal",id:"azure-portal",children:[],level:4}],level:3}],level:2},{value:"Admin and developer access",id:"admin-and-developer-access",children:[{value:"Azure AD Kubernetes Proxy",id:"azure-ad-kubernetes-proxy",children:[{value:"AZAD Usage",id:"azad-usage",children:[],level:4}],level:3},{value:"AAD groups",id:"aad-groups",children:[{value:"No subscription",id:"no-subscription",children:[],level:4},{value:"Developer groups",id:"developer-groups",children:[],level:4},{value:"Admin groups",id:"admin-groups",children:[],level:4},{value:"Verify access",id:"verify-access",children:[],level:4}],level:3},{value:"Authorized IPs",id:"authorized-ips",children:[],level:3}],level:2}],c={toc:d};function m(e){var t=e.components,n=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"bootstrap"},"Bootstrap"),(0,o.kt)("h2",{id:"add-new-tenant"},"Add New Tenant"),(0,o.kt)("p",null,"When creating a new tenant there are a number of (for now manual) processes to perform."),(0,o.kt)("p",null,"In this scenario we are assuming that you are using Azure DevOps and that you have already created a project and organization."),(0,o.kt)("p",null,"In many places in the text we have provided names, they are just examples, all of these names can be exchanged to fit your needs. In this case let us call it ",(0,o.kt)("inlineCode",{parentName:"p"},"project1"),". In the future we should manually import a repository.\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/azure-devops-templates"},"https://github.com/XenitAB/azure-devops-templates")),(0,o.kt)("h3",{id:"import-azure-devops-templates-pipeline"},"Import azure-devops-templates pipeline"),(0,o.kt)("p",null,"To make sure that the ",(0,o.kt)("inlineCode",{parentName:"p"},"azure-devops-templates")," repo is up to date we have an automatic CI that fetches updates from upstream to your local Azure DevOps clone."),(0,o.kt)("p",null,"Go to pipelines -> New pipeline -> Azure Repos Git -> azure-devops-templates -> Existing Azure Pipelines YAML file"),(0,o.kt)("p",null,"Import the pipeline from the following path: ",(0,o.kt)("inlineCode",{parentName:"p"},"/.ci/pipeline.yaml")),(0,o.kt)("h3",{id:"setup-xks"},"Setup XKS"),(0,o.kt)("p",null,"In this case we will only setup a single XKS cluster in one environment, in our case dev. It is easy to add more environments when you have created your first one."),(0,o.kt)("p",null,"At Xenit we are using Terraform modules that we share ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/terraform-modules"},"upstream")),(0,o.kt)("p",null,"To setup XKS we will utilize 4 modules:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"governance-global"),(0,o.kt)("li",{parentName:"ul"},"governance-regional"),(0,o.kt)("li",{parentName:"ul"},"core"),(0,o.kt)("li",{parentName:"ul"},"aks")),(0,o.kt)("h3",{id:"create-terraform-repo"},"Create Terraform repo"),(0,o.kt)("p",null,"Of course we need a place to store our Terraform code so create one in your Azure DevOps organization.\nTODO create a example repo that uses our Terraform modules."),(0,o.kt)("p",null,"You can today see a example of the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/github-actions/blob/main/docker/template/Makefile"},"Makefile"),"."),(0,o.kt)("p",null,"This is how we normally ",(0,o.kt)("a",{parentName:"p",href:"https://www.terraform.io/docs/language/modules/develop/structure.html"},"structure")," our tenant repo."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-txt"},"\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 aks\n\u2502\xa0\xa0 \u251c\u2500\u2500 main.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 outputs.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 variables\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 common.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 dev.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 prod.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 qa.tfvars\n\u2502\xa0\xa0 \u2514\u2500\u2500 variables.tf\n\u251c\u2500\u2500 core\n\u2502\xa0\xa0 \u251c\u2500\u2500 main.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 outputs.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 variables\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 common.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 dev.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 prod.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 qa.tfvars\n\u2502\xa0\xa0 \u2514\u2500\u2500 variables.tf\n\u251c\u2500\u2500 global.tfvars\n\u251c\u2500\u2500 governance\n\u2502\xa0\xa0 \u251c\u2500\u2500 main.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 outputs.tf\n\u2502\xa0\xa0 \u251c\u2500\u2500 variables\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 common.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 dev.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u251c\u2500\u2500 prod.tfvars\n\u2502\xa0\xa0 \u2502\xa0\xa0 \u2514\u2500\u2500 qa.tfvars\n\u2502\xa0\xa0 \u2514\u2500\u2500 variables.tf\n")),(0,o.kt)("h3",{id:"update-repo"},"Update repo"),(0,o.kt)("p",null,"We need to update a number of settings in a number of places in your Terraform repo."),(0,o.kt)("p",null,"Generate a SUFFIX that should be tfstate + a few random numbers, for example ",(0,o.kt)("inlineCode",{parentName:"p"},"tfstate1234"),"."),(0,o.kt)("p",null,"Update the Makefile SUFFIX variable with the suffix and the random number."),(0,o.kt)("p",null,"Also update global.tfvars with the same random number."),(0,o.kt)("h3",{id:"create-terraform-storage"},"Create Terraform storage"),(0,o.kt)("p",null,"In order to store a Terraform state we need to prepare that."),(0,o.kt)("p",null,"We have written a small Go tool that will help out with ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/github-actions/tree/main/docker/go-tf-prepare"},"that"),"."),(0,o.kt)("p",null,"Instead of running these scripts manually we will use the makefile."),(0,o.kt)("p",null,"We use one Terrafrom state per ",(0,o.kt)("inlineCode",{parentName:"p"},"DIR")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"ENV"),".\nLets create the first Terraform state, in this case governance."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"make prepare ENV=dev DIR=governance")),(0,o.kt)("p",null,"You will need to run the prepare command for each separate Terraform folder."),(0,o.kt)("h3",{id:"configure-governance"},"Configure governance"),(0,o.kt)("p",null,"After defining the variables and you have have applied your config:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"make plan ENV=dev DIR=governance\n# If everything looks good\nmake apply ENV=dev DIR=governance\n")),(0,o.kt)("p",null,"By default you don't get access to the key vaults that governance creates.\nYou should probably give the access to a group that you and your team have access to but to get started you can run the following."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'AZ_ID=$(az ad user show --id "your@email" --output tsv --query objectId)\nKEYVAULTNAME=kv-favorite-name\naz keyvault set-policy --name $KEYVAULTNAME --object-id $AZ_ID --secret-permissions backup delete get list purge recover restore set --key-permissions backup create decrypt delete encrypt get import list purge recover restore sign unwrapKey update verify wrapKey --certificate-permissions backup create delete deleteissuers get getissuers import list listissuers managecontacts manageissuers purge recover restore setissuers update\n')),(0,o.kt)("h3",{id:"configure-core"},"Configure core"),(0,o.kt)("p",null,"Get a CIDR network for your AKS env per env.\nDefine in ",(0,o.kt)("inlineCode",{parentName:"p"},"core/variables/env.tfvars"),"."),(0,o.kt)("h3",{id:"configure-aks-cluster"},"Configure AKS cluster"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"How big should your cluster be?"),(0,o.kt)("li",{parentName:"ul"},"Which version of Kubernetes should you run?"),(0,o.kt)("li",{parentName:"ul"},"What DNS zone should you use?"),(0,o.kt)("li",{parentName:"ul"},"What SKU tier should your cluster have?"),(0,o.kt)("li",{parentName:"ul"},"What size should your k8s nodes have?")),(0,o.kt)("p",null,"All of this is configured under ",(0,o.kt)("inlineCode",{parentName:"p"},"aks/variables/prod.tfvars"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-prod.tfvars"},'environment = "prod"\ndns_zone    = "prod.aks.xenit.io"\n\naks_config = {\n  kubernetes_version = "1.20.7"\n  sku_tier           = "Free"\n  default_node_pool = {\n    orchestrator_version = "1.20.7"\n    vm_size              = "Standard_D2as_v4"\n    min_count            = 1\n    max_count            = 1\n    node_labels          = {}\n  },\n  additional_node_pools = [\n    {\n      name                 = "standard2"\n      orchestrator_version = "1.20.7"\n      vm_size              = "Standard_D2as_v4"\n      min_count            = 1\n      max_count            = 4\n      node_labels          = {}\n      node_taints          = []\n    },\n  ]\n}\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Notice the vm_size = Standard_D2as_v4")),(0,o.kt)("h3",{id:"gitops-using-flux"},"GitOps using Flux"),(0,o.kt)("p",null,"If you want Flux to manage your GitOps repo from the get go you can enable this in ",(0,o.kt)("inlineCode",{parentName:"p"},"aks/variables/common.tfvars"),".\nIn my case I will have Flux manage a namespace called monitor and sync a repo under ",(0,o.kt)("inlineCode",{parentName:"p"},"monitor-gitops"),"."),(0,o.kt)("p",null,"You need to create the repository in Azure Devops that you link to before applying this Terraform.\nThe repository can be empty."),(0,o.kt)("p",null,"You will also need to create a separate repository for ",(0,o.kt)("inlineCode",{parentName:"p"},"fleet-infra"),", this repo is used to store Flux config."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"This repo cannot be empty and needs a README file or something similar to work as intended before you run Terraform.")),(0,o.kt)("p",null,"In the example below we are using Azure DevOps as our CSM system, but we also support GitHub.\nIf you want to use GitHub just fill in its config and make ",(0,o.kt)("inlineCode",{parentName:"p"},"azure_devops")," empty instead."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-common.tfvars"},'namespaces = [\n  {\n    name                    = "monitor"\n    delegate_resource_group = true\n    labels = {\n      "terraform" = "true"\n    }\n    flux = {\n      enabled = true\n      azure_devops = {\n        org  = "organization1"\n        proj = "project1"\n        repo = "monitor-gitops"\n      }\n      github = {\n        repo = ""\n      }\n    }\n  }\n]\n')),(0,o.kt)("h2",{id:"terraform-cicd"},"Terraform CI/CD"),(0,o.kt)("p",null,"We have one CI/CD pipeline per terraform directory.\nYou can find ready to use pipelines under ",(0,o.kt)("inlineCode",{parentName:"p"},".ci/")," in the Terraform repo."),(0,o.kt)("h3",{id:"configure-service-principal"},"Configure service principal"),(0,o.kt)("p",null,"There are a few manual steps that you need to perform before we can start to configure the CI/CD pipeline."),(0,o.kt)("h4",{id:"service-principal-access"},"Service principal access"),(0,o.kt)("p",null,"A couple of manual steps are required before Terraform can be applied. A main service principal has to be created in the tenants Azure AD, as it will be used by the Terraform modules."),(0,o.kt)("p",null,"Create the new service principal. It should have a name with the format ",(0,o.kt)("inlineCode",{parentName:"p"},"sp-sub-<subscription_name>-all-owner"),". Most likely the subscription name will be ",(0,o.kt)("inlineCode",{parentName:"p"},"xks"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},'AZ_APP_NAME="sp-sub-<subscription_name>-all-owner"\nAZ_APP_ID=$(az ad app create --display-name ${AZ_APP_NAME} --query appId -o tsv)\nAZ_APP_OBJECT_ID=$(az ad app show --id ${AZ_APP_ID} --output tsv --query objectId)\naz ad sp create --id ${AZ_APP_OBJECT_ID}\n')),(0,o.kt)("p",null,"Grant the service principal additional permissions in the App Registration. The permissions ",(0,o.kt)("inlineCode",{parentName:"p"},"Group.ReadWrite.All")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Application.ReadWrite.All")," in Microsoft Graph should be added. After the\npermissions are added grant admin consent for the Tenant."),(0,o.kt)("p",null,"Make the service principal ",(0,o.kt)("inlineCode",{parentName:"p"},"Owner")," of all the XKS subscriptions. This is done in the IAM settings of each individual subscription. Additionaly the service principal also needs to be member of the User\nadministrator role."),(0,o.kt)("p",null,"Create three Azure AD groups. These will be used to assing users a owner, contributor, or reader role for all resources.."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"az ad group create --display-name az-sub-<subscription_name>-all-owner --mail-nickname az-sub-<subscription_name>-all-owner\naz ad group create --display-name az-sub-<subscription_name>-all-contributor --mail-nickname az-sub-<subscription_name>-all-contributor\naz ad group create --display-name az-sub-<subscription_name>-all-reader --mail-nickname az-sub-<subscription_name>-all-reader\n")),(0,o.kt)("p",null,"You can also view to original documentation on how to ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/terraform-modules/blob/main/modules/azure/README.md"},"create a SP"),"."),(0,o.kt)("p",null,"In some cases it might be useful to create a group where both a admin group for you as an admin the SP can use and assign the group the needed access.\nDepending on how your ",(0,o.kt)("inlineCode",{parentName:"p"},"global.tfvars")," looks like it will be called something like: ",(0,o.kt)("inlineCode",{parentName:"p"},"az-mg-lz-xks-owner"),"."),(0,o.kt)("h4",{id:"create-service-principal-key"},"Create Service principal key"),(0,o.kt)("p",null,"The SP that we use is generated by Terraform but we do not store the key anywhere,\nso this is among the few times that we have to do something manual."),(0,o.kt)("p",null,"First find the SP that you will use, this will depend on your Terraform config."),(0,o.kt)("p",null,"There is no CLI command to create a new key so it is done through the portal."),(0,o.kt)("p",null,"AAD -> App registrations -> All applications -> ",(0,o.kt)("em",{parentName:"p"},"search for the application")," -> Certificates & secrets -> New client secret"),(0,o.kt)("p",null,"The key is only shown once, so copy it some where safe for long-term storage. This key will be used when creating the service connection in Azure DevOps."),(0,o.kt)("h3",{id:"setup-service-connection"},"Setup Service Connection"),(0,o.kt)("p",null,"To be able to talk from Azure DevOps to Azure and be able to run Terraform on push we need to configure service connections.\nNow you will also need the key that we created in the SP earlier."),(0,o.kt)("p",null,"Get the config:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# Service Principal Id\nAPP_ID=$(az ad sp list --display-name sp-sub-xks-all-owner -o tsv --query '[].appId')\n# Tenant ID\nTENANT_ID=$(az account show -o tsv --query tenantId)\n# Subscription Id\nSUB_ID=$(az account show -o tsv --query id)\n")),(0,o.kt)("p",null,"In Azure DevOps:\nProject settings -> Service connections -> New service connection -> Azure Resource Manager -> Service principal (manual)"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Subscription Id = $SUB_ID"),(0,o.kt)("li",{parentName:"ul"},"Service Principal Id = $APP_ID"),(0,o.kt)("li",{parentName:"ul"},"Service principal key = The key created in the earlier step"),(0,o.kt)("li",{parentName:"ul"},"Tenant ID = $TENANT_ID"),(0,o.kt)("li",{parentName:"ul"},"Service connection name = xks-${environment}-owner")),(0,o.kt)("h3",{id:"update-pipelines"},"Update pipelines"),(0,o.kt)("p",null,"Update the variable ",(0,o.kt)("inlineCode",{parentName:"p"},"azureSubscriptionTemplate"),". You can find the value under Project settings -> Service Connections"),(0,o.kt)("img",{alt:"Service Connections",src:(0,i.Z)("img/assets/xks/operator-guide/project_settings.png")}),(0,o.kt)("p",null,"In my case ",(0,o.kt)("inlineCode",{parentName:"p"},"sp-sub-project1-xks"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'name: $(Build.BuildId)\n\nvariables:\n  - name: azureSubscriptionTemplate\n    value: "sp-sub-project1-xks-{0}-owner"\n  - name: terraformFolder\n    value: "governance"\n  - name: sourceBranch\n    value: "refs/heads/main"\n')),(0,o.kt)("p",null,'Also update the project path in "name". Also notice the ref, the ref points to which version of the module that you are using:'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"resources:\n  repositories:\n    - repository: templates\n      type: git\n      name: project1/azure-devops-templates\n      ref: refs/tags/2021.03.1\n")),(0,o.kt)("h3",{id:"add-cicd-pipelines"},"Add CI/CD pipelines"),(0,o.kt)("p",null,"Once again add a pipeline."),(0,o.kt)("p",null,"Assuming that you named your repository to Terraform"),(0,o.kt)("p",null,"Pipelines -> New pipeline -> Azure Repos Git -> Terraform -> Existing Azure Pipelines YAML file"),(0,o.kt)("p",null,"Import the pipeline from the following path: ",(0,o.kt)("inlineCode",{parentName:"p"},".ci/pipeline-governance.yaml")),(0,o.kt)("p",null,"Hopefully after adding the pipeline the pipeline should automatically trigger and the plan and apply stages should go through without any problems."),(0,o.kt)("h3",{id:"create-pat-secret"},"Create PAT secret"),(0,o.kt)("p",null,"To make it possible for flux to clone repos from azure devops we need to create a Personal Access Token(PAT)."),(0,o.kt)("p",null,"User Settings -> Personal access tokens -> New Token"),(0,o.kt)("img",{alt:"Settings user",src:(0,i.Z)("img/assets/xks/operator-guide/settings_user.png")}),(0,o.kt)("p",null,"Create a PAT"),(0,o.kt)("img",{alt:"Create PAT",src:(0,i.Z)("img/assets/xks/operator-guide/create_pat.png")}),(0,o.kt)("p",null,"Copy the generated key, we will need it for the next step."),(0,o.kt)("h3",{id:"add-pat-to-azure-key-vaults"},"Add PAT to Azure Key Vaults"),(0,o.kt)("p",null,"To make it possible for terraform to reach the PAT in a easy and secure way we have chosen to store the PAT in Azure Key Vaults which you need to add manually."),(0,o.kt)("h4",{id:"azure-cli"},"Azure CLI"),(0,o.kt)("p",null,"You can add the secret using the ",(0,o.kt)("inlineCode",{parentName:"p"},"az")," CLI."),(0,o.kt)("p",null,"Call the secret ",(0,o.kt)("inlineCode",{parentName:"p"},"azure-devops-pat")," and the value should be the token you created in Azure DevOps."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'# List all key vaults\naz keyvault list\n\n# Create the secret\naz keyvault secret set --vault-name kv-dev-we-core-1234 --name azure-devops-pat --value "SuperSecretToken123"\n')),(0,o.kt)("h4",{id:"azure-portal"},"Azure portal"),(0,o.kt)("p",null,"Or if you prefer use the UI."),(0,o.kt)("p",null,'In the Azure portal search for "Key vaults" and pick the core one that matches the unique_suffix that you have specified in ',(0,o.kt)("inlineCode",{parentName:"p"},"global.tfvars"),", in our case 1234."),(0,o.kt)("p",null,"Key vaults -> core-1234 -> Secrets -> Generate/Import"),(0,o.kt)("img",{alt:"Azure Key Vaults",src:(0,i.Z)("img/assets/xks/operator-guide/azure_key_vault.jpg")}),(0,o.kt)("p",null,"Call the secret ",(0,o.kt)("inlineCode",{parentName:"p"},"azure-devops-pat")," and add the PAT key that you created in the previous step."),(0,o.kt)("h2",{id:"admin-and-developer-access"},"Admin and developer access"),(0,o.kt)("p",null,"Hopefully you should now have one XKS cluster up and running, but currently no developer can actually reach the cluster."),(0,o.kt)("p",null,"In XKF we see clusters as cattle and at any time we can decide to recreate an XKS cluster.\nTo be able to do this without our developers even knowing we use blue green clusters. TODO write a document on how blue green clusters works and link.\nWe use GitOps together with DNS to be able to migrate applications without any impact to end-users assuming that our developers have written 12 step applications.\nTo store state we utilize the cloud services available in the different clouds that XKF supports."),(0,o.kt)("p",null,"To make sure that our developers do not notice when we change our the cluster we have written a Kubernetes API Proxy called ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/azad-kube-proxy"},"azad-kube-proxy"),"."),(0,o.kt)("h3",{id:"azure-ad-kubernetes-proxy"},"Azure AD Kubernetes Proxy"),(0,o.kt)("p",null,"AZAD as we also call it, is a deployment that runs inside XKS and sits in front of the Kubernetes API."),(0,o.kt)("p",null,"We also supply a krew/kubectl plugin to make it easy for our developers to use AZAD.\nFor instructions on how to setup and configure this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/XenitAB/azad-kube-proxy"},"see"),"."),(0,o.kt)("h4",{id:"azad-usage"},"AZAD Usage"),(0,o.kt)("p",null,"Install krew: ",(0,o.kt)("a",{parentName:"p",href:"https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows"},"https://krew.sigs.k8s.io/docs/user-guide/setup/install/#windows"),"\nInstall the azad-proxy plugin: ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl krew install azad-proxy"),"\nLogin with the Azure CLI (a valid session with azure cli is always required): ",(0,o.kt)("inlineCode",{parentName:"p"},"az login"),"\nList all the available clusters: ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl azad-proxy menu")),(0,o.kt)("p",null,"You can also use the discover function:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"kubectl azad-proxy discover\nkubectl azad-proxy generate --cluster-name dev-cluster --proxy-url https://dev.example.com --resource https://dev.example.com\n")),(0,o.kt)("h3",{id:"aad-groups"},"AAD groups"),(0,o.kt)("p",null,"To make it possible for our developers and admins to actually login to the cluster we need to add them to a AAD group."),(0,o.kt)("p",null,"If you are a AAD guest user you need to add the AAD Role: ",(0,o.kt)("strong",{parentName:"p"},"Directory Reader")," to your user account.\nAZAD proxy parses the AAD and that is why the user needs Directory Reader."),(0,o.kt)("h4",{id:"no-subscription"},"No subscription"),(0,o.kt)("p",null,"If you have not gotten any of the RG groups that XKF generates and perform ",(0,o.kt)("inlineCode",{parentName:"p"},"az login")," you might see an error\nsaying that you do not have any subscriptions."),(0,o.kt)("p",null,"This is more likely if you are running XKF in AWS but also possible in Azure.\nDo as the error suggest and use the ",(0,o.kt)("inlineCode",{parentName:"p"},"--allow-no-subscription")," flag."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-shell"},"# The variable TENANT_ID = your tenant id\naz login $TENANT_ID --allow-no-subscription\n")),(0,o.kt)("p",null,"AZAD proxy should still work."),(0,o.kt)("h4",{id:"developer-groups"},"Developer groups"),(0,o.kt)("p",null,"Depending on what configuration you did in ",(0,o.kt)("inlineCode",{parentName:"p"},"global.tfvars")," this will differ but the group name should be something like bellow."),(0,o.kt)("p",null,"This group will give your developers contributor access in the namespaces where they have access."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"<azure_ad_group_prefix>-rg-xks-<cluster-env>-aks-contributor")),(0,o.kt)("p",null,"Example: ",(0,o.kt)("inlineCode",{parentName:"p"},"az-rg-xks-dev-aks-contributor")),(0,o.kt)("h4",{id:"admin-groups"},"Admin groups"),(0,o.kt)("p",null,"To make it easy for you as a admin you should also use AZAD."),(0,o.kt)("p",null,"To give yourself cluster-admin access:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"<azure_ad_group_prefix>-xks-<cluster-env>-clusteradmin")),(0,o.kt)("p",null,"Example: ",(0,o.kt)("inlineCode",{parentName:"p"},"aks-xks-dev-clusteradmin")),(0,o.kt)("h4",{id:"verify-access"},"Verify access"),(0,o.kt)("p",null,"There is a flag in Kubernetes called ",(0,o.kt)("inlineCode",{parentName:"p"},"--as"),", which enables you to see if a specific user got access to a specific resource."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Note this will not work if you are connecting to the cluster using AZAD-proxy due to it using the ",(0,o.kt)("inlineCode",{parentName:"p"},"--as")," flag to run the commands for you.")),(0,o.kt)("p",null,"Since we are using OIDC we also need to provide the group id, you can find the group id in AAD.\nYou can find the UUID of the group in AAD."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},'kubectl get pods --as-group=12345678-1234-1234-1234-00000000000 --as="fake"')),(0,o.kt)("p",null,"If you already have a rolebinding where a existing UUID exist you can run the following command:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get pods --as-group=$(kubectl get rolebinding <rolebiding-name> -o jsonpath='{.subjects[0].name}') --as=\"fake\"")),(0,o.kt)("h3",{id:"authorized-ips"},"Authorized IPs"),(0,o.kt)("p",null,"To minimize the exposure of the XKS clusters we define a list of authorized IP:s that is approved to connect the Kubernetes cluster API."),(0,o.kt)("p",null,"We need to approve multiple infrastructure networks and user networks."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"If you are using the HUB module and you are running VMSS Azure Devops Agent you need to approve those IP:s as authorized."),(0,o.kt)("li",{parentName:"ul"},"The AKS public IP"),(0,o.kt)("li",{parentName:"ul"},"Your developers' public IP")),(0,o.kt)("p",null,"A recommendation is to add a comment with what IP you have added."),(0,o.kt)("p",null,"aks_authorized_ips = ",'[\n"8.8.8.8/32", # google dns\n"1.2.3.4/32", # developer x ip\n"2.3.4.5/30", # AKS0 dev\n]'))}m.isMDXComponent=!0}}]);