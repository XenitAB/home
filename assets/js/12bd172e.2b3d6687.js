"use strict";(self.webpackChunkhome=self.webpackChunkhome||[]).push([[283],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u=r.createContext({}),s=function(e){var t=r.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=s(e.components);return r.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},p=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,u=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=s(n),m=o,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||a;return n?r.createElement(f,i(i({ref:t},c),{},{components:n})):r.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=p;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var s=2;s<a;s++)i[s]=n[s];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}p.displayName="MDXCreateElement"},777:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return u},metadata:function(){return s},toc:function(){return c},default:function(){return p}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=["components"],l={id:"blue-green",title:"Blue Green Clusters"},u=void 0,s={unversionedId:"xks/operator-guide/blue-green",id:"xks/operator-guide/blue-green",isDocsHomePage:!1,title:"Blue Green Clusters",description:"For different reasons you might want to create a completely new cluster, this can be due to many reasons like:",source:"@site/docs/xks/operator-guide/blue-green.md",sourceDirName:"xks/operator-guide",slug:"/xks/operator-guide/blue-green",permalink:"/docs/xks/operator-guide/blue-green",editUrl:"https://github.com/xenitab/xenitab.github.io/edit/main/docs/xks/operator-guide/blue-green.md",tags:[],version:"current",frontMatter:{id:"blue-green",title:"Blue Green Clusters"},sidebar:"docs",previous:{title:"Blast Radius",permalink:"/docs/xks/operator-guide/blast-radius"},next:{title:"AWS azure-devops",permalink:"/docs/xks/operator-guide/aws-azdo"}},c=[{value:"Workflow",id:"workflow",children:[],level:2},{value:"DNS migration",id:"dns-migration",children:[{value:"Azure",id:"azure",children:[],level:3}],level:2}],d={toc:c};function p(e){var t=e.components,n=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"For different reasons you might want to create a completely new cluster, this can be due to many reasons like:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Broken cluster"),(0,a.kt)("li",{parentName:"ul"},"Test patch the cluster"),(0,a.kt)("li",{parentName:"ul"},"Major breaking change")),(0,a.kt)("p",null,"Thanks to this XKF support performing blue-green deployment on an entire kubernetes cluster, this is applicable for both Azure and AWS.\nThese docs is intended for both clouds, the main difference is in the naming."),(0,a.kt)("p",null,"Today XKS does not support any way of only doing blue green on a specific environment.\nIf you need too perform blue green on QA you should do it in dev and prod as well.\nWe think that the risk is to great that you by mistake would get drift between the modules used in the different clusters would be to great."),(0,a.kt)("h2",{id:"workflow"},"Workflow"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"We assume that the workloads on the clusters are stateless and can run multiple instances.")),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Set up a new cluster in the target environment using Terraform"),(0,a.kt)("li",{parentName:"ol"},"Verify that the new cluster is functioning as intended",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"You ",(0,a.kt)("strong",{parentName:"li"},"won't")," be able to verify any ingress"),(0,a.kt)("li",{parentName:"ul"},"You ",(0,a.kt)("strong",{parentName:"li"},"won't")," be able to use AZAD-proxy in the newly created cluster"))),(0,a.kt)("li",{parentName:"ol"},"Change the TXT DNS records over to the newly created cluster"),(0,a.kt)("li",{parentName:"ol"},"Verify that the ingress traffic is migrated to the new cluster and it is working as intended"),(0,a.kt)("li",{parentName:"ol"},"Destroy the old cluster using terraform")),(0,a.kt)("h2",{id:"dns-migration"},"DNS migration"),(0,a.kt)("p",null,"You can find a small small script bellow to make the migration of DNS easier.\nAs always use at your own risk and make sure that you understand what the script does."),(0,a.kt)("p",null,"Our recommendation is that you migrate one DNS record manually and verify that the ingress and the new cluster is working as intended,\nwhen you know that you can run the script."),(0,a.kt)("h3",{id:"azure"},"Azure"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'ENVIRONMENT="dev"\nOLD_OWNER_ID="${ENVIRONMENT}-aks1"\nNEW_OWNER_ID="${ENVIRONMENT}-aks2"\nRESOURCE_GROUP_NAME="rg-${ENVIRONMENT}-we-aks"\nZONE_NAME="${ENVIRONMENT}.domain.se"\nZONE_RECORDS=$(az network dns record-set txt list -g ${RESOURCE_GROUP_NAME} -z ${ZONE_NAME} | jq -rc \'.[]\')\nZONE_RECORDS_CSV_ARRAY=( $(jq -rc \'. | [.name, (.txtRecords[0].value[0] | @base64)] | join(";")\' <<< "${ZONE_RECORDS}") )\nfor ZONE_RECORD_CSV in "${ZONE_RECORDS_CSV_ARRAY[@]}"; do\n  ZONE_RECORD_NAME=$(awk -F\';\' \'{print $1}\' <<< $ZONE_RECORD_CSV)\n  OLD_ZONE_TXT_VALUE=$(awk -F\';\' \'{print $2}\' <<< $ZONE_RECORD_CSV | base64 -d)\n  if [[ ${OLD_ZONE_TXT_VALUE} =~ "owner=${OLD_OWNER_ID}" ]]; then\n    NEW_ZONE_TXT_VALUE=${OLD_ZONE_TXT_VALUE/owner=${OLD_OWNER_ID}/owner=${NEW_OWNER_ID}}\n    echo Updating external-dns owner of ${ZONE_RECORD_NAME}: ${OLD_OWNER_ID} to ${NEW_OWNER_ID}\n    az network dns record-set txt add-record --resource-group ${RESOURCE_GROUP_NAME} --zone-name ${ZONE_NAME} --record-set-name ${ZONE_RECORD_NAME} --value "${NEW_ZONE_TXT_VALUE}" 1>/dev/null\n    az network dns record-set txt remove-record --resource-group ${RESOURCE_GROUP_NAME} --zone-name ${ZONE_NAME} --record-set-name ${ZONE_RECORD_NAME} --value "${OLD_ZONE_TXT_VALUE}" 1>/dev/null\n  fi\ndone\n')))}p.isMDXComponent=!0}}]);