(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{102:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return l})),a.d(t,"metadata",(function(){return c})),a.d(t,"rightToc",(function(){return b})),a.d(t,"default",(function(){return m}));var n=a(3),r=a(7),o=(a(0),a(134)),l={title:"Terraform (Docker)",slug:"/azure-devops-templates/terraform-docker",custom_edit_url:"https://github.com/XenitAB/azure-devops-templates/edit/main/terraform-docker/README.md"},c={unversionedId:"azure-devops-templates/terraform-docker",id:"azure-devops-templates/terraform-docker",isDocsHomePage:!1,title:"Terraform (Docker)",description:"The Terraform templates (using Docker) are used to run Terraform in a dev->qa->prod environment promotion flow.",source:"@site/docs/azure-devops-templates/terraform-docker.md",slug:"/azure-devops-templates/terraform-docker",permalink:"/docs/azure-devops-templates/terraform-docker",editUrl:"https://github.com/XenitAB/azure-devops-templates/edit/main/terraform-docker/README.md",version:"current",sidebar:"docs",previous:{title:"Terraform",permalink:"/docs/azure-devops-templates/terraform"}},b=[{value:"Architecture",id:"architecture",children:[]},{value:"Template Format",id:"template-format",children:[]},{value:"AWS vs Azure",id:"aws-vs-azure",children:[{value:"AWS config",id:"aws-config",children:[]}]},{value:"Plan",id:"plan",children:[]},{value:"Apply",id:"apply",children:[]},{value:"Examples",id:"examples",children:[{value:"Pipeline",id:"pipeline",children:[]},{value:"Makefile",id:"makefile",children:[]}]}],i={rightToc:b};function m(e){var t=e.components,l=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},i,l,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"The Terraform templates (using Docker) are used to run Terraform in a ",Object(o.b)("inlineCode",{parentName:"p"},"dev->qa->prod")," environment promotion flow."),Object(o.b)("h2",{id:"architecture"},"Architecture"),Object(o.b)("p",null,Object(o.b)("img",{alt:"terraform-architecture",src:a(161).default})),Object(o.b)("h2",{id:"template-format"},"Template Format"),Object(o.b)("p",null,"Parameter names that end with ",Object(o.b)("inlineCode",{parentName:"p"},"Template")," will be templated before they are used. They are templted with the ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=azure-devops#format"}),"format command"),".\nThe format command is passed the environment name, which can be placed in the string."),Object(o.b)("h2",{id:"aws-vs-azure"},"AWS vs Azure"),Object(o.b)("p",null,"The template is built to support both Azure and AWS.\nAzure have to be used since we store our state in Azure, but we support two service connections in a single pipeline."),Object(o.b)("h3",{id:"aws-config"},"AWS config"),Object(o.b)("p",null,"As a user of the template you have the power to define any ARN policy that you want to use.\nThis is allot of power but the main protection is that you can't exceed the access you got in your AWS service connection.\nSo as long as the you have given the service connection a ",Object(o.b)("strong",{parentName:"p"},"reasonable")," amount of access you are okay."),Object(o.b)("p",null,"The Makefile supports AWS environment variables. If you don't use AWS it will just mount empty volumes."),Object(o.b)("h2",{id:"plan"},"Plan"),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Name"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Default"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"poolNameTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of pool to use in template format.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"sourceBranch"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'"refs/heads/master"')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Source branch to limit image builds to.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"environments"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"[{name: dev}, {name: qa}, {name: prod}]")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Environments that should be deployed to.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"azureSubscriptionTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of Azure subscription in template format.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"terraformFolder"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Path to Terraform directory.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"validateEnabled"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"true")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Should ",Object(o.b)("inlineCode",{parentName:"td"},"make validate")," run during plan?")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsRegion"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"The name of the AWS region you want to use")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsServiceConnectionTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of AWS service connection in template format")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsArn"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"The AWS arn to use when applying config to AWS")))),Object(o.b)("h2",{id:"apply"},"Apply"),Object(o.b)("table",null,Object(o.b)("thead",{parentName:"table"},Object(o.b)("tr",{parentName:"thead"},Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Name"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Default"),Object(o.b)("th",Object(n.a)({parentName:"tr"},{align:null}),"Description"))),Object(o.b)("tbody",{parentName:"table"},Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"poolNameTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of pool to use in template format.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"sourceBranch"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'"refs/heads/master"')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Source branch to limit image builds to.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"azureSubscriptionTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of Azure subscription in template format.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"terraformFolder"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Path to Terraform directory.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"environments"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},"[{name: dev, deployTags: false}, {name: qa, deployTags: true}, {name: prod, deployTags: true}]")),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Environments that should be deployed to.")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsRegion"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"The name of the AWS region you want to use")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsServiceConnectionTemplate"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"Name of AWS service connection in template format")),Object(o.b)("tr",{parentName:"tbody"},Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"awsArn"),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),Object(o.b)("inlineCode",{parentName:"td"},'""')),Object(o.b)("td",Object(n.a)({parentName:"tr"},{align:null}),"The AWS arn to use when applying config to AWS")))),Object(o.b)("h2",{id:"examples"},"Examples"),Object(o.b)("h3",{id:"pipeline"},"Pipeline"),Object(o.b)("h4",{id:"azure"},"Azure"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),'name: $(Build.BuildId)\n\ntrigger:\n  batch: true\n  branches:\n    include:\n      - master\n  paths:\n    include:\n      - TF_FOLDER_NAME\n\nresources:\n  repositories:\n    - repository: templates\n      type: git\n      name: PROJ/azure-devops-templates\n      ref: resf/tags/2020.12.1\n\nstages:\n  - template: terraform-docker/plan/main.yaml@templates\n    parameters:\n      azureSubscriptionTemplate: "SUB"\n      poolNameTemplate: "POOL"\n      terraformFolder: "TF_FOLDER_NAME"\n  - template: terraform-docker/apply/main.yaml@templates\n    parameters:\n      azureSubscriptionTemplate: "SUB"\n      poolNameTemplate: "POOL"\n      terraformFolder: "TF_FOLDER_NAME"\n')),Object(o.b)("h4",{id:"aws"},"AWS"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-yaml"}),'name: $(Build.BuildId)\n\ntrigger:\n  batch: true\n  branches:\n    include:\n      - main\n  paths:\n    include:\n      - TF_FOLDER_NAME\n\nresources:\n  repositories:\n    - repository: templates\n      type: git\n      name: PROJ/azure-devops-templates\n      ref: resf/tags/2021.07.1\n\nstages:\n  - template: terraform-docker/plan/main.yaml@templates\n    parameters:\n      azureSubscriptionTemplate: "SUB"\n      poolNameTemplate: "POOL"\n      terraformFolder: "TF_FOLDER_NAME"\n      awsServiceConnectionTemplate: terraform_aws_{0}\n      awsRegion: eu-west-1\n      awsArn: arn:aws:iam::aws:policy/RandomBuiltInPolicy\n\n  - template: terraform-docker/apply/main.yaml@templates\n    parameters:\n      azureSubscriptionTemplate: "SUB"\n      poolNameTemplate: "POOL"\n      terraformFolder: "TF_FOLDER_NAME"\n      awsServiceConnectionTemplate: terraform_aws_{0}\n      awsRegion: eu-west-1\n      awsArn: arn:aws:iam::aws:policy/RandomBuiltInPolicy\n')),Object(o.b)("h3",{id:"makefile"},"Makefile"),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-makefile"}),'SHELL:=/bin/bash\n\nSUFFIX="tfstate<4 random digits>"\nIMAGE="ghcr.io/xenitab/github-actions/tools:2021.05.2"\nENV?=""\nDIR?=""\nOPA_BLAST_RADIUS := $(if $(OPA_BLAST_RADIUS), $(OPA_BLAST_RADIUS), 50)\nAZURE_CONFIG_DIR := $(if $(AZURE_CONFIG_DIR), $(AZURE_CONFIG_DIR), "$${HOME}/.azure")\n\ncheck:\nifeq ($(ENV),"")\n    echo "Need to set ENV"\n    exit 1\nendif\nifeq ($(DIR),"")\n    echo "Need to set DIR"\n    exit 1\nendif\n\nplan: check\n    docker run --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) plan $(DIR) $(ENV) $(SUFFIX) $(OPA_BLAST_RADIUS)\n\napply: check\n    docker run --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) apply $(DIR) $(ENV) $(SUFFIX)\n\nprepare: check\n    docker run --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) prepare $(DIR) $(ENV) $(SUFFIX)\n\ndestroy: check\n    docker run -it --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) destroy $(DIR) $(ENV) $(SUFFIX)\n\nstate-remove: check\n    docker run -it --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) state-remove $(DIR) $(ENV) $(SUFFIX)\n\nvalidate: check\n    docker run --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) validate $(DIR) $(ENV) $(SUFFIX)\n\nfmt: check\n    docker run --entrypoint "/opt/terraform.sh" -e AWS_PROFILE=$${AWS_PROFILE} -v $${PWD}/$(DIR)/.terraform/$(ENV).env:/tmp/$(ENV).env -v $(AZURE_CONFIG_DIR):/home/tools/.azure -v $${AWS_CONFIG_FILE}:/home/tools/.aws/config -v $${AWS_SHARED_CREDENTIALS_FILE}:/home/tools/.aws/credentials -v $${PWD}/$(DIR):/tmp/$(DIR) -v $${PWD}/global.tfvars:/tmp/global.tfvars $(IMAGE) "fmt -recursive" $(DIR) $(ENV) $(SUFFIX)\n')))}m.isMDXComponent=!0},134:function(e,t,a){"use strict";a.d(t,"a",(function(){return p})),a.d(t,"b",(function(){return u}));var n=a(0),r=a.n(n);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function c(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function b(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=r.a.createContext({}),m=function(e){var t=r.a.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):c(c({},t),e)),a},p=function(e){var t=m(e.components);return r.a.createElement(i.Provider,{value:t},e.children)},s={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,o=e.originalType,l=e.parentName,i=b(e,["components","mdxType","originalType","parentName"]),p=m(a),d=n,u=p["".concat(l,".").concat(d)]||p[d]||s[d]||o;return a?r.a.createElement(u,c(c({ref:t},i),{},{components:a})):r.a.createElement(u,c({ref:t},i))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=a.length,l=new Array(o);l[0]=d;var c={};for(var b in t)hasOwnProperty.call(t,b)&&(c[b]=t[b]);c.originalType=e,c.mdxType="string"==typeof e?e:n,l[1]=c;for(var i=2;i<o;i++)l[i]=a[i];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,a)}d.displayName="MDXCreateElement"},161:function(e,t,a){"use strict";a.r(t),t.default=a.p+"assets/images/terraform-architecture-c640744bb489e813c3d841591a0ec6c0.jpg"}}]);